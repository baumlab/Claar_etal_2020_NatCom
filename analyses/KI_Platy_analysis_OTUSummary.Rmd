---
title: "KI_Platy_analysis_OTUSummary"
output: 
  html_document:
    toc: true
    toc_float: true
---

<!-- Setup, import libraries, and load RData -->
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(phyloseq)
library(data.table)
library(VennDiagram)

rm(list=ls())

load("C:/Users/Dani/Documents/Data_Analysis/KI_Platy/data/KI_seqs_f_coral_grouped.RData")

# Look at tax_table
tax_table(phy97.f.c)

```


# Symbiont alpha-diversity - Grouped by Species  

First, we look at how many *Symbiodinium* types (OTUs) and clades are present in each coral species:

<!-- Calculate OTU and clade diversity by species -->
```{r, include=TRUE, echo=FALSE, cache=TRUE}
# PLATYGYRA  
# Number of OTUs:
platy.ntaxa <- ntaxa(phy97.f.c.platy)
# Number of Clades:
platy.nclades  <- sum(table(unlist(sort((unique((data.frame(tax_table(phy97.f.c.platy))[9])$clade))))))
platy.clades <- levels(unique((data.frame(tax_table(phy97.f.c.platy))[9])$clade))
# FAVITES PENTAGONA  
# Number of OTUs:
favites.ntaxa <- ntaxa(phy97.f.c.fpenta)
# Number of Clades:
favites.nclades <- sum(table(unlist(sort((unique((data.frame(tax_table(phy97.f.c.fpenta))[9])$clade))))))
favites.clades <- levels(unique((data.frame(tax_table(phy97.f.c.fpenta))[9])$clade))
# FAVIA  
# Number of OTUs:
favia.ntaxa <- ntaxa(phy97.f.c.faviaall)
# Number of Clades:
favia.nclades <- sum(table(unlist(sort((unique((data.frame(tax_table(phy97.f.c.faviaall))[9])$clade))))))
favia.clades <- levels(unique((data.frame(tax_table(phy97.f.c.faviaall))[9])$clade))
```

<!-- Plot OTU and clade diversity by species -->
```{r, include=TRUE, echo=FALSE, cache=TRUE}
# Make a data frame including the number of OTUs
df <- data.frame(Platygyra=platy.ntaxa,Favia=favia.ntaxa,Favites=favites.ntaxa)
# Add the number of clades to the data frame
df[2,] <- c(platy.nclades,favia.nclades,favites.nclades)
# Set the row names
rownames(df) <- c("Number of OTUs","Number of Clades")
# Transpose the data frame
df <- t(df)
# Print the data frame
df

# Create and print a barplot of these data
barplot(df, names.arg=c("Number of OTUs","Number of Clades"), beside=TRUE, legend=rownames(df), col=c("deepskyblue4","lightblue","darkcyan"),ylim = c(0,max(df)))

# Create a pdf of this plot and save in the 'figures' folder
# Open a new pdf file
pdf(file="C:/Users/Dani/Documents/Data_Analysis/KI_Platy/figures/OTUSummary/Diversity_by_Species.pdf")
# Make the plot
barplot(df, names.arg=c("Number of OTUs","Number of Clades"), beside=TRUE, legend=rownames(df), col=c("deepskyblue4","lightblue","darkcyan"),ylim = c(0,max(df)))
# Close the pdf file
dev.off()

```

# Sample sizes for different coral taxa
```{r, sample_sizes include=TRUE, echo=FALSE, cache=TRUE}
# Number of samples - PLATYGYRA SP.
sum(sample_data(phy97.f.c.coral)$Coral_Species=="Platygyra_sp")
# Number of tagged colonies - PLATYGYRA SP.
unique(sample_data(phy97.f.c.platy)$CoralTag)
#  PLATYGYRA SP.
plot_bar(phy97.f.c.platy.p,fill="hit")

# Number of samples - FAVITES PENTAGONA
sum(sample_data(phy97.f.c.coral)$Coral_Species=="Favites_pentagona")
# Number of tagged colonies - FAVITES PENTAGONA
unique(sample_data(phy97.f.c.fpenta)$CoralTag)
#  FAVITES PENTAGONA
plot_bar(phy97.f.c.fpenta.p,fill="hit")

# Number of samples - FAVIA MATTHAI
sum(sample_data(phy97.f.c.coral)$Coral_Species=="Favia_matthai")
# Number of tagged colonies - FAVIA MATTHAI
unique(sample_data(phy97.f.c.faviam)$CoralTag)
#  FAVIA MATTHAI
plot_bar(phy97.f.c.faviam.p,fill="hit")
```

# Symbiont alpha-diversity - Grouped by Sites (and SampleType)  

  
Next, we look at the number of *Symbiodinium* types (OTUs) and clades in coral at each Kiritimati site:  

<!-- Calculate OTU and clade diversity by site -->
```{r, include=TRUE, echo=FALSE, cache=TRUE}
for (i in unique(data.frame(sample_data(phy97.f.c.coral))$Site)){
  nam <- paste("site",i,".coral.ntaxa",sep="")
  nam2 <- paste("site",i,".coral.nclades",sep="")
  nam3 <- paste("site",i,".coral.clades",sep="")
  ornam <- get(paste("phy97.f.c.coral.site",i,sep=""))
  a <- eval(ntaxa(ornam))
  assign(nam,a)
  b <- eval(sum(table(unlist(sort((unique((data.frame(tax_table(ornam))[9])$clade)))))))
  assign(nam2,b)
  c <- eval(levels(unique((data.frame(tax_table(ornam))[9])$clade)))
  assign(nam3,c)
}
```

<!-- Plot OTU and clade diversity by site -->
```{r, include=TRUE, echo=FALSE, cache=TRUE}
df2 <- data.frame(site3=site3.coral.ntaxa,site5=site5.coral.ntaxa,site8=site8.coral.ntaxa,site14=site14.coral.ntaxa,site15=site15.coral.ntaxa,site19=site19.coral.ntaxa,site25=site25.coral.ntaxa,site27=site27.coral.ntaxa,site30=site30.coral.ntaxa,site32=site32.coral.ntaxa,site34=site34.coral.ntaxa,site35=site35.coral.ntaxa,site37=site37.coral.ntaxa,site38=site38.coral.ntaxa,site40=site40.coral.ntaxa)
df2[2,] <- c(site3.coral.nclades,site5.coral.nclades,site8.coral.nclades,site14.coral.nclades,site15.coral.nclades,site19.coral.nclades,site25.coral.nclades,site27.coral.nclades,site30.coral.nclades,site32.coral.nclades,site34.coral.nclades,site35.coral.nclades,site37.coral.nclades,site38.coral.nclades,site40.coral.nclades)
df2[3,] <- c(2,5,3,3,6,6,2,1,1,1,3,3,5,2,1)
rownames(df2) <- c("Number of OTUs","Number of Clades", "Dist")
df2 <- t(df2)
df2 <- df2[order(df2[,3]),]
df2

mycols <- c("#d7191c", "#fdae61", "#ffffbf", "#abdda4", "#abdda4", "#2b83ba")
  
palette(mycols)

par(xpd=TRUE)
barplot(df2[,1:2], names.arg=c("Number of OTUs","Number of Clades"), beside=TRUE, col=df2[,3],ylim = c(0,max(df2)),main="Corals by Site")
legend("topright", inset=c(0.05,-0.05), legend=rownames(df2), fill=df2[,3],cex=0.7)


pdf(file="C:/Users/Dani/Documents/Data_Analysis/KI_Platy/figures/OTUSummary/Diversity_Corals_by_Site.pdf", width=10, height=7)
par(xpd=TRUE)
barplot(df2[,1:2], names.arg=c("Number of OTUs","Number of Clades"), beside=TRUE, col=df2[,3],ylim = c(0,max(df2)),main="Corals by Site")
legend("topright", inset=c(0.05,-0.05), legend=rownames(df2), fill=df2[,3],cex=0.7)
dev.off()
```


  
# Symbiont alpha-diversity - Grouped by Field Season  
  
To understand how *Symbiodinium* diversity changes among field seasons, clade diversity is divided by field season. This includes coral-associated *Symbiodinium*.  
  
<!-- Calculate OTU and clade diversity by field season -->
```{r, include=TRUE, echo=FALSE, cache=TRUE}
# 2014  
# Number of OTUs:
s2014.ntaxa <- ntaxa(phy97.f.c.coral.2014)
# Number of Clades:
s2014.nclades  <- sum(table(unlist(sort((unique((data.frame(tax_table(phy97.f.c.coral.2014))[9])$clade))))))
s2014.clades <- levels(unique((data.frame(tax_table(phy97.f.c.coral.2014))[9])$clade))

# 2015 Jan
# Number of OTUs:
s2015Jan.ntaxa <- ntaxa(phy97.f.c.coral.2015Jan)
# Number of Clades:
s2015Jan.nclades  <- sum(table(unlist(sort((unique((data.frame(tax_table(phy97.f.c.coral.2015Jan))[9])$clade))))))
s2015Jan.clades <- levels(unique((data.frame(tax_table(phy97.f.c.coral.2015Jan))[9])$clade))

# 2015 May
# Number of OTUs:
s2015May.ntaxa <- ntaxa(phy97.f.c.coral.2015May)
# Number of Clades:
s2015May.nclades  <- sum(table(unlist(sort((unique((data.frame(tax_table(phy97.f.c.coral.2015May))[9])$clade))))))
s2015May.clades <- levels(unique((data.frame(tax_table(phy97.f.c.coral.2015May))[9])$clade))

# 2015 July
# Number of OTUs:
s2015July.ntaxa <- ntaxa(phy97.f.c.coral.2015July)
# Number of Clades:
s2015July.nclades  <- sum(table(unlist(sort((unique((data.frame(tax_table(phy97.f.c.coral.2015July))[9])$clade))))))
s2015July.clades <- levels(unique((data.frame(tax_table(phy97.f.c.coral.2015July))[9])$clade))

# 2016 March
# Number of OTUs:
s2016March.ntaxa <- ntaxa(phy97.f.c.coral.2016March)
# Number of Clades:
s2016March.nclades  <- sum(table(unlist(sort((unique((data.frame(tax_table(phy97.f.c.coral.2016March))[9])$clade))))))
s2016March.clades <- levels(unique((data.frame(tax_table(phy97.f.c.coral.2016March))[9])$clade))
```

<!-- Plot OTU and clade diversity by site -->
```{r, include=TRUE, echo=FALSE, cache=TRUE}
# Make a data frame for plotting OTU and clade diversity by site
df3 <- data.frame(s2014=s2014.ntaxa,s2015Jan=s2015Jan.ntaxa,s2015May=s2015May.ntaxa,s2015July=s2015July.ntaxa,s2016March=s2016March.ntaxa)
df3[2,] <- c(s2014=s2014.nclades,s2015Jan=s2015Jan.nclades,s2015May=s2015May.nclades,s2015July=s2015July.nclades,s2016March=s2016March.nclades)
rownames(df3) <- c("Number of OTUs","Number of Clades")
df3 <- t(df3)
# Print the data frame
df3

# Set colors for the plot
mycols <- c("#2b83ba", "#abdda4", "#ffffbf", "#fdae61", "#d7191c")
palette(mycols)

# Make the plot in the RMD document
par(xpd=TRUE)
barplot(df3, names.arg=c("Number of OTUs","Number of Clades"), beside=TRUE, col=mycols,ylim = c(0,max(df3)))
legend("topright", legend=rownames(df3), fill=mycols, cex=0.7)

# Make the pdf of the plot
pdf(file="C:/Users/Dani/Documents/Data_Analysis/KI_Platy/figures/OTUSummary/Diversity_by_FieldSeason.pdf", width=10, height=7)
par(xpd=TRUE)
barplot(df3, names.arg=c("Number of OTUs","Number of Clades"), beside=TRUE, col=mycols,ylim = c(0,max(df3)))
legend("topright", legend=rownames(df3), fill=mycols, cex=0.7)
dev.off()
```


The overall number of OTUs and clades observed during each field season were equal, showing stable diversity at the ecosystem (or meta-community) level.

<!-- Plot unique Symbiont types by coral taxa -->
```{r, include=TRUE, echo=FALSE, cache=TRUE}
# Platygyra
# Number of Symbiodinium Types:
platy.ntaxa <- length(unique(data.frame(tax_table(phy97.f.c.platy))$hit))
platy.ntaxa.before <- length(unique(data.frame(tax_table(phy97.f.c.platy.AD.before))$hit))
platy.ntaxa.durAft <- length(unique(data.frame(tax_table(phy97.f.c.platy.AD.da))$hit))
# Total 
platy.ntaxa
# Before the event
platy.ntaxa.before
# During/after the event
platy.ntaxa.durAft

# Favites pentagona
# Number of Symbiodinium Types:
fpenta.ntaxa <- length(unique(data.frame(tax_table(phy97.f.c.fpenta))$hit))
fpenta.ntaxa.before <- length(unique(data.frame(tax_table(phy97.f.c.fpenta.AD.before))$hit))
fpenta.ntaxa.durAft <- length(unique(data.frame(tax_table(phy97.f.c.fpenta.AD.da))$hit))
# Total 
fpenta.ntaxa
# Before the event
fpenta.ntaxa.before
# During/after the event
fpenta.ntaxa.durAft

df4 <- t(data.frame("Platy all"= platy.ntaxa, "Platy before"=platy.ntaxa.before, "Platy during/after"=platy.ntaxa.durAft,"FPenta all"=fpenta.ntaxa,"Fpenta before"= fpenta.ntaxa.before, "FPenta during/after"=fpenta.ntaxa.durAft))
# Make the plot in the RMD document
par(xpd=TRUE,mar=c(3,3,3,11))
barplot(df4, names.arg=c("Platy all","Platy before", "Platy during/after","FPenta all", "Fpenta before","FPenta during/after"), beside=TRUE, col=c("deepskyblue4","deepskyblue4","deepskyblue4","lightblue","lightblue","lightblue"), ylim = c(0,max(df4)))
legend(7.1,20, legend=rownames(df4), fill=c("deepskyblue4","deepskyblue4","deepskyblue4","lightblue","lightblue","lightblue"), cex=0.7)

```

# Principal and Background Types  

Background *Symbiodinium* types are those which have <0.01% abundance, and Principal *Symbiodinium* types are those which ahve >0.01% abunance (per Quigley et al 2017).  
  
Looking at coral samples only:  
<!-- Principal and Background Types - Corals -->
```{r, include=TRUE, echo=FALSE, cache=TRUE}
# Define the principal coral types
principal.coral.A <- sum(data.frame(tax_table(principal.coral))$clade=="A")
principal.coral.C <- sum(data.frame(tax_table(principal.coral))$clade=="C")
principal.coral.D <- sum(data.frame(tax_table(principal.coral))$clade=="D")
principal.coral.F <- sum(data.frame(tax_table(principal.coral))$clade=="F")
principal.coral.G <- sum(data.frame(tax_table(principal.coral))$clade=="G")
principal.coral.I <- sum(data.frame(tax_table(principal.coral))$clade=="I")

# Print Principal coral types
print("PRINCIPAL CORAL TYPES")

# Define principal coral clades
principal.coral.clades <- c(A=principal.coral.A,C=principal.coral.C,D=principal.coral.D,F=principal.coral.F,G=principal.coral.G,I=principal.coral.I)

# List and print principal coral types
principal.coral.types <- data.frame(tax_table(principal.coral))$hit
principal.coral.types

# Define Background Types
background.coral.A <- sum(data.frame(tax_table(background.coral))$clade=="A")
background.coral.C <- sum(data.frame(tax_table(background.coral))$clade=="C")
background.coral.D <- sum(data.frame(tax_table(background.coral))$clade=="D")
background.coral.F <- sum(data.frame(tax_table(background.coral))$clade=="F")
background.coral.G <- sum(data.frame(tax_table(background.coral))$clade=="G")
background.coral.I <- sum(data.frame(tax_table(background.coral))$clade=="I")

# Print "Background Coral Types"
print("BACKGROUND CORAL TYPES")

# Define Background Clades
background.coral.clades <- c(A=background.coral.A,C=background.coral.C,D=background.coral.D,F=background.coral.F,G=background.coral.G,I=background.coral.I)

# List and print background types
background.coral.types <- data.frame(tax_table(background.coral))$hit
background.coral.types

# Create data frame of background and principal coral clades
principal.coral.background.coral.clades <- rbind(principal.coral.clades,background.coral.clades)
t.principal.coral.background.coral.clades <- t(principal.coral.background.coral.clades)
colnames(t.principal.coral.background.coral.clades) <- c("Principal.coral Types", "Background.coral Types")

# Plot background and principal coral clades
barplot(t.principal.coral.background.coral.clades,col=rainbow(6),beside=TRUE, ylim=c(0,max(t.principal.coral.background.coral.clades)), main="Coral only")
legend("topleft", legend=rownames(t.principal.coral.background.coral.clades), fill=rainbow(6))

# Make pdf of background and principal coral clades
pdf(file="C:/Users/Dani/Documents/Data_Analysis/KI_Platy/figures/OTUSummary/Background.coral_Pricipal_Clades.pdf", width=10, height=7)
par(xpd=TRUE)
barplot(t.principal.coral.background.coral.clades,col=rainbow(6),beside=TRUE, ylim=c(0,max(t.principal.coral.background.coral.clades)), main="Coral only")
legend("topleft", legend=rownames(t.principal.coral.background.coral.clades), fill=rainbow(6))
dev.off()
```
  

<!-- Core vs. Common vs. Rare -->  
```{r, include=TRUE, echo=FALSE, cache=TRUE}
# Extract OTU names from Coral core, common, and rare types
names.coral.core <- names(coral.core)
names.coral.common <- names(coral.common)
names.coral.rare <- names(coral.rare)
```
  
Print hits for core, common, and rare in coral
```{r, include=TRUE, echo=FALSE, cache=TRUE}
if (!is.null(names.coral.core)) {
  coral.core.hits <- data.frame()
  for (i in names.coral.core){
    coral.core.hits[i,1] <- paste((data.frame(tax_table(phy97.f.c.coral)))[i,]$hit)
  }
  colnames(coral.core.hits) <- "hits"
  print("coral.core.hits")
  coral.core.hits
} else {
  print("There were no core hits (for coral)")
}

if (!is.null(names.coral.common)) {
  coral.common.hits <- data.frame()
  for (i in names.coral.common){
    coral.common.hits[i,1] <- paste((data.frame(tax_table(phy97.f.c.coral)))[i,]$hit)
  }
  colnames(coral.common.hits) <- "hits"
  print("coral.common.hits")
  coral.common.hits
} else {
  print("There were no common hits (for coral)")
}

if (!is.null(names.coral.rare)) {
  coral.rare.hits <- data.frame()
  for (i in names.coral.rare){
    coral.rare.hits[i,1] <- paste((data.frame(tax_table(phy97.f.c.coral)))[i,]$hit)
  }
  colnames(coral.rare.hits) <- "hits"
  print("coral.rare.hits")
  coral.rare.hits
} else {
  print("There were no rare hits (for coral)")
}

```

# Abundance vs. Prevalence

<!-- Abundance vs. prevalence - Coral -->
```{r, include=TRUE, echo=FALSE, cache=TRUE}
# This is abundance
phy97.f.c.coral.otuAbundance <- data.frame(otuAbundance = taxa_sums(phy97.f.c.coral))
# This is prevalence
phy97.f.c.coral.otuPrevalence <- data.frame(otuPrevalence = (rowSums(sign(data.frame(otu_table(phy97.f.c.coral))))/(nrow(sample_data(phy97.f.c.coral)))))

phy97.f.c.coral.AbundPrev <- cbind(log(phy97.f.c.coral.otuAbundance),phy97.f.c.coral.otuPrevalence,hit=(data.frame(tax_table(phy97.f.c.coral)))$hit,clade=(data.frame(tax_table(phy97.f.c.coral)))$clade)

palette(rainbow(5))
plot(phy97.f.c.coral.AbundPrev[,1:2],xlab="Log OTU Abundance",ylab="OTU Prevalence", main="Coral",col=phy97.f.c.coral.AbundPrev$clade, pch=16)
# legend("topleft",inset=c(0.05,0.05), legend=phy97.f.c.coral.AbundPrev$hit, fill=phy97.f.c.coral.AbundPrev$clade, cex=0.5, text.width=2.5, ncol=3, xpd=TRUE)
```

```{r, include=TRUE, echo=FALSE, cache=TRUE}
# Save grouped data as RData file
save.image(file = "C:/Users/Dani/Documents/Data_Analysis/KI_Platy/data/otus_97/KI_seqs_f_coral_grouped_OTUSummary.RData")
```

